<!DOCTYPE html><html><head><title>SECrackRock.m</title><meta http-equiv="content-type" content="text/html; charset=UTF-8"><link rel="stylesheet" media="all" href="doc-style.css"><script src="doc-filelist.js"></script><script>var relativeDir = '', thisFile = '/Users/bryn/.otis/templates/tmpl.jade', defaultSidebar = true;</script><script src="doc-script.js"></script></head><body><div id="sidebar_wrapper"><div id="sidebar_switch"><span class="tree">Files</span><span class="headings">Headings</span></div><div id="tree"></div><div id="headings"><div class="heading h2"><a href="#instance-methods">Instance methods</a></div><div class="heading h4"><a href="#initwithfreeproducts-paidproductids-">initWithFreeProducts:paidProductIDs:</a></div><div class="heading h4"><a href="#dealloc">dealloc</a></div><div class="heading h4"><a href="#purchase-completion-">purchase:completion:</a></div><div class="heading h4"><a href="#restoreallpurchases-">restoreAllPurchases:</a></div><div class="heading h1"><a href="#pragma-mark-kvo">pragma mark KVO</a></div><div class="heading h4"><a href="#requestedproductnotvalid-">requestedProductNotValid:</a></div><div class="heading h4"><a href="#requestedproductvalidated-">requestedProductValidated:</a></div><div class="heading h4"><a href="#successfulpurchase-receipt-">successfulPurchase:receipt:</a></div><div class="heading h4"><a href="#cancelledpurchase-">cancelledPurchase:</a></div><div class="heading h4"><a href="#failedpurchase-message-">failedPurchase:message:</a></div><div class="heading h4"><a href="#successfulrestore-receipt-">successfulRestore:receipt:</a></div><div class="heading h4"><a href="#successfulmultiplerestorecomplete">successfulMultipleRestoreComplete</a></div><div class="heading h4"><a href="#incompleterestore">incompleteRestore</a></div><div class="heading h4"><a href="#failedrestore-message-">failedRestore:message:</a></div><div class="heading h4"><a href="#paymentqueue-updatedtransactions-">paymentQueue:updatedTransactions:</a></div><div class="heading h4"><a href="#paymentqueue-removedtransactions-">paymentQueue:removedTransactions:</a></div><div class="heading h4"><a href="#paymentqueuerestorecompletedtransactionsfinished-">paymentQueueRestoreCompletedTransactionsFinished:</a></div><div class="heading h4"><a href="#paymentqueue-restorecompletedtransactionsfailedwitherror-">paymentQueue:restoreCompletedTransactionsFailedWithError:</a></div></div></div><div id="sidebar-toggle"></div><div id="container"><div class="background highlight"></div><table cellpadding="0" cellspacing="0"><tbody><tr><td class="docs"></td><td class="code highlight"></td></tr><tr><td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1">&#182;</a>
</div>
<p>SECrackRock.m
 iOS-CrackRock iOS in-app purchase framework</p>

<p>Created by bryn austin bellomy on 7/16/12.
 Copyright (c) 2012 bryn austin bellomy. All rights reserved.</p></td><td class="code highlight"><div class="highlight"><pre><span class="cp">#import &lt;StateMachine-GCDThreadsafe/StateMachine.h&gt;</span>
<span class="cp">#import &lt;BrynKit/BrynKit.h&gt;</span>
<span class="cp">#import &lt;BrynKit/RACSubject+SERACHelpers.h&gt;</span>
<span class="cp">#import &lt;libextobjc/EXTScope.h&gt;</span>
<span class="cp">#import &lt;Underscore.m/Underscore.h&gt;</span>
<span class="cp">#import &lt;ReactiveCocoa/ReactiveCocoa.h&gt;</span>
<span class="cp">#import &lt;ReactiveCocoa/NSNotificationCenter+RACSupport.h&gt;</span>

<span class="cp">#import &quot;SECrackRock.h&quot;</span>
<span class="cp">#import &quot;SECrackRockProduct.h&quot;</span>
<span class="cp">#import &quot;SECrackRockProduct-Private.h&quot;</span>
<span class="cp">#import &quot;SECrackRockProductsRequest.h&quot;</span>


<span class="cp">#define _ Underscore</span>


<span class="k">@interface</span> <span class="nc">SECrackRock</span> <span class="p">()</span> <span class="o">&lt;</span><span class="n">SEThreadsafeStateMachine</span><span class="o">&gt;</span>
    <span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">assign</span><span class="p">,</span> <span class="n">readwrite</span><span class="p">)</span> <span class="kt">BOOL</span> <span class="n">isCurrentlyRestoringMultiplePurchases</span><span class="p">;</span>
    <span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">assign</span><span class="p">,</span> <span class="n">readwrite</span><span class="p">)</span> <span class="kt">BOOL</span> <span class="n">restoreWasInitiatedByUser</span><span class="p">;</span>

    <span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">,</span> <span class="n">readwrite</span><span class="p">)</span> <span class="n">SECrackRockProductsRequest</span> <span class="o">*</span><span class="n">productsRequest</span><span class="p">;</span>
    <span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">,</span> <span class="n">readwrite</span><span class="p">)</span> <span class="n">NSSet</span> <span class="o">*</span><span class="n">freeProducts</span><span class="p">;</span>
    <span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">,</span> <span class="n">readwrite</span><span class="p">)</span> <span class="n">NSSet</span> <span class="o">*</span><span class="n">paidProducts</span><span class="p">;</span>
    <span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">,</span> <span class="n">readwrite</span><span class="p">)</span> <span class="n">NSSet</span> <span class="o">*</span><span class="n">purchasedProducts</span><span class="p">;</span>
    <span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">,</span> <span class="n">readwrite</span><span class="p">)</span> <span class="n">NSSet</span> <span class="o">*</span><span class="n">products</span><span class="p">;</span>

    <span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">assign</span><span class="p">,</span> <span class="n">readwrite</span><span class="p">)</span> <span class="n">dispatch_queue_t</span> <span class="n">queueCritical</span><span class="p">;</span>

    <span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">copy</span><span class="p">,</span>   <span class="n">readwrite</span><span class="p">)</span> <span class="n">SECrackRockTransactionResponseBlock</span> <span class="n">blockTransactionCompletion</span><span class="p">;</span>

    <span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">copy</span><span class="p">,</span> <span class="n">readwrite</span><span class="p">)</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">state</span><span class="p">;</span>
<span class="k">@end</span>

<span class="k">@interface</span> <span class="nc">SECrackRock</span> <span class="nl">(SKPaymentTransactionObserver)</span> <span class="o">&lt;</span><span class="n">SKPaymentTransactionObserver</span><span class="o">&gt;</span>
<span class="k">@end</span>



<span class="k">@interface</span> <span class="nc">SECrackRock</span> <span class="nl">(StateMachine_Private)</span>
    <span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">initializeStateMachine</span><span class="p">;</span>
    <span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">requestProducts</span><span class="p">;</span>
    <span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">transactionComplete</span><span class="p">;</span>
    <span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">purchase</span><span class="p">;</span>
    <span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">restore</span><span class="p">;</span>
    <span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">error</span><span class="p">;</span>
    <span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">transactionComplete</span><span class="p">;</span>
    <span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">requestProducts</span><span class="p">;</span>
<span class="k">@end</span>



<span class="k">@implementation</span> <span class="nc">SECrackRock</span>
<span class="err">@</span><span class="n">gcd_threadsafe</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">logLevel</span> <span class="o">=</span> <span class="n">LOG_LEVEL_VERBOSE</span><span class="p">;</span>
<span class="k">+</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span>  <span class="nf">ddLogLevel</span>               <span class="p">{</span> <span class="k">return</span> <span class="n">logLevel</span><span class="p">;</span>  <span class="p">}</span>
<span class="k">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">ddSetLogLevel:</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="nv">level</span> <span class="p">{</span> <span class="n">logLevel</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span> <span class="p">}</span>

<span class="cp">#pragma mark- StateMachine</span>
<span class="cp">#pragma mark-</span>

<span class="n">STATE_MACHINE</span><span class="p">(</span><span class="o">^</span><span class="p">(</span><span class="n">LSStateMachine</span> <span class="o">*</span><span class="n">sm</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sm</span><span class="p">.</span><span class="n">initialState</span> <span class="o">=</span> <span class="n">SECrackRockState_Uninitialized</span><span class="p">;</span></pre></div></td></tr><tr><td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2">&#182;</a>
</div>
<p>states</p></td><td class="code highlight"><div class="highlight"><pre>    <span class="p">[</span><span class="n">sm</span> <span class="nl">addState:</span><span class="n">SECrackRockState_Uninitialized</span><span class="p">];</span>
    <span class="p">[</span><span class="n">sm</span> <span class="nl">addState:</span><span class="n">SECrackRockState_Ready</span><span class="p">];</span>
    <span class="p">[</span><span class="n">sm</span> <span class="nl">addState:</span><span class="n">SECrackRockState_Purchasing</span><span class="p">];</span>
    <span class="p">[</span><span class="n">sm</span> <span class="nl">addState:</span><span class="n">SECrackRockState_Restoring</span><span class="p">];</span>
    <span class="p">[</span><span class="n">sm</span> <span class="nl">addState:</span><span class="n">SECrackRockState_Requesting</span><span class="p">];</span>
    <span class="p">[</span><span class="n">sm</span> <span class="nl">addState:</span><span class="n">SECrackRockState_Error</span><span class="p">];</span></pre></div></td></tr><tr><td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3">&#182;</a>
</div>
<p>transitions</p></td><td class="code highlight"><div class="highlight"><pre></pre></div></td></tr><tr><td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4">&#182;</a>
</div>
<p>request valid IAPs</p></td><td class="code highlight"><div class="highlight"><pre>    <span class="p">[</span><span class="n">sm</span> <span class="nl">when:</span><span class="n">SECrackRockEvent_RequestProducts</span>     <span class="nl">transitionFrom:</span><span class="n">SECrackRockState_Uninitialized</span> <span class="nl">to:</span><span class="n">SECrackRockState_Requesting</span><span class="p">];</span>
    <span class="p">[</span><span class="n">sm</span> <span class="nl">when:</span><span class="n">SECrackRockEvent_RequestProducts</span>     <span class="nl">transitionFrom:</span><span class="n">SECrackRockState_Ready</span>         <span class="nl">to:</span><span class="n">SECrackRockState_Requesting</span><span class="p">];</span>
    <span class="p">[</span><span class="n">sm</span> <span class="nl">when:</span><span class="n">SECrackRockEvent_TransactionComplete</span> <span class="nl">transitionFrom:</span><span class="n">SECrackRockState_Requesting</span>    <span class="nl">to:</span><span class="n">SECrackRockState_Ready</span><span class="p">];</span>

    <span class="p">[</span><span class="n">sm</span> <span class="nl">after:</span><span class="n">SECrackRockEvent_RequestProducts</span> <span class="k">do</span><span class="o">:^</span><span class="p">(</span><span class="n">SECrackRock</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span> <span class="p">{</span>
        <span class="err">@</span><span class="n">weakify</span><span class="p">(</span><span class="n">self</span><span class="p">);</span></pre></div></td></tr><tr><td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5">&#182;</a>
</div>
<p>pluck the product IDs</p></td><td class="code highlight"><div class="highlight"><pre>        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;self.paidProducts = %@&quot;</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">paidProducts</span><span class="p">);</span>
        <span class="n">NSArray</span> <span class="o">*</span><span class="n">productIDs</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">paidProducts</span>
            <span class="p">.</span><span class="n">rac_sequence</span><span class="p">.</span><span class="n">signal</span>
             <span class="nl">map:</span><span class="o">^</span><span class="kt">id</span><span class="p">(</span><span class="n">SECrackRockProduct</span> <span class="o">*</span><span class="n">product</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">product</span><span class="p">.</span><span class="n">productID</span><span class="p">;</span> <span class="p">}]</span>
            <span class="p">.</span><span class="n">toArray</span><span class="p">;</span>

        <span class="n">NSSet</span> <span class="o">*</span><span class="n">productIDsSet</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSSet</span> <span class="nl">setWithArray:</span> <span class="n">productIDs</span><span class="p">];</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;productIDs = %@&quot;</span><span class="p">,</span> <span class="n">productIDs</span><span class="p">);</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;[NSSet setWithArray:productIDs] = %@&quot;</span><span class="p">,</span> <span class="n">productIDsSet</span><span class="p">);</span>

        <span class="n">RACSignal</span> <span class="o">*</span><span class="n">rac_productsRequest</span> <span class="o">=</span> <span class="p">[</span><span class="n">SECrackRockProductsRequest</span> <span class="nl">rac_productsRequestForProductIDs:</span> <span class="n">productIDsSet</span>
                                                                                            <span class="nl">scheduler:</span><span class="p">[</span><span class="n">RACScheduler</span> <span class="n">scheduler</span><span class="p">]];</span>

        <span class="p">[</span><span class="n">rac_productsRequest</span> <span class="nl">subscribeNext:</span><span class="o">^</span><span class="p">(</span><span class="n">RACTuple</span> <span class="o">*</span><span class="n">response</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">RACTupleUnpack</span><span class="p">(</span><span class="n">NSSet</span> <span class="o">*</span><span class="n">validProducts</span><span class="p">,</span> <span class="n">NSSet</span> <span class="o">*</span><span class="n">invalidProductIDs</span><span class="p">)</span> <span class="o">=</span> <span class="n">response</span><span class="p">;</span>
            <span class="err">@</span><span class="n">strongify</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
            <span class="n">lllog</span><span class="p">(</span><span class="n">Info</span><span class="p">,</span> <span class="s">@&quot;%d valid product IDs, %d invalid product IDs&quot;</span><span class="p">,</span> <span class="n">validProducts</span><span class="p">.</span><span class="n">count</span><span class="p">,</span> <span class="n">invalidProductIDs</span><span class="p">.</span><span class="n">count</span><span class="p">);</span></pre></div></td></tr><tr><td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6">&#182;</a>
</div>
<p>update our cached products with the received product info</p></td><td class="code highlight"><div class="highlight"><pre>            <span class="k">for</span> <span class="p">(</span><span class="n">SKProduct</span> <span class="o">*</span><span class="n">product</span> <span class="k">in</span> <span class="n">validProducts</span><span class="p">)</span> <span class="p">{</span>
                <span class="p">[</span><span class="n">self</span> <span class="nl">requestedProductValidated:</span> <span class="n">product</span><span class="p">];</span>
            <span class="p">}</span></pre></div></td></tr><tr><td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7">&#182;</a>
</div>
<p>if any of the requested product IDs were not valid, mark them as such</p></td><td class="code highlight"><div class="highlight"><pre>            <span class="k">for</span> <span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="n">invalidProductID</span> <span class="k">in</span> <span class="n">invalidProductIDs</span><span class="p">)</span> <span class="p">{</span>
                <span class="p">[</span><span class="n">self</span> <span class="nl">requestedProductNotValid:</span><span class="n">invalidProductID</span><span class="p">];</span>
            <span class="p">}</span>

        <span class="p">}</span> <span class="nl">error:</span><span class="o">^</span><span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="err">@</span><span class="n">strongify</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
            <span class="n">lllog</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="s">@&quot;error = %@&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
            <span class="p">[</span><span class="n">self</span> <span class="n">error</span><span class="p">];</span>
        <span class="p">}];</span>
    <span class="p">}];</span></pre></div></td></tr><tr><td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8">&#182;</a>
</div>
<p>purchase</p></td><td class="code highlight"><div class="highlight"><pre>    <span class="p">[</span><span class="n">sm</span> <span class="nl">when:</span><span class="n">SECrackRockEvent_Purchase</span>            <span class="nl">transitionFrom:</span><span class="n">SECrackRockState_Ready</span> <span class="nl">to:</span><span class="n">SECrackRockState_Purchasing</span><span class="p">];</span>
    <span class="p">[</span><span class="n">sm</span> <span class="nl">when:</span><span class="n">SECrackRockEvent_TransactionComplete</span> <span class="nl">transitionFrom:</span><span class="n">SECrackRockState_Purchasing</span> <span class="nl">to:</span><span class="n">SECrackRockState_Ready</span><span class="p">];</span></pre></div></td></tr><tr><td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9">&#182;</a>
</div>
<p>restore</p></td><td class="code highlight"><div class="highlight"><pre>    <span class="p">[</span><span class="n">sm</span> <span class="nl">when:</span><span class="n">SECrackRockEvent_Restore</span>             <span class="nl">transitionFrom:</span><span class="n">SECrackRockState_Ready</span> <span class="nl">to:</span><span class="n">SECrackRockState_Restoring</span><span class="p">];</span>
    <span class="p">[</span><span class="n">sm</span> <span class="nl">when:</span><span class="n">SECrackRockEvent_TransactionComplete</span> <span class="nl">transitionFrom:</span><span class="n">SECrackRockState_Restoring</span> <span class="nl">to:</span><span class="n">SECrackRockState_Ready</span><span class="p">];</span></pre></div></td></tr><tr><td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10">&#182;</a>
</div>
<p>error</p></td><td class="code highlight"><div class="highlight"><pre>    <span class="p">[</span><span class="n">sm</span> <span class="nl">when:</span><span class="n">SECrackRockEvent_Error</span> <span class="nl">transitionFrom:</span><span class="n">SECrackRockState_Uninitialized</span> <span class="nl">to:</span><span class="n">SECrackRockState_Error</span><span class="p">];</span>
    <span class="p">[</span><span class="n">sm</span> <span class="nl">when:</span><span class="n">SECrackRockEvent_Error</span> <span class="nl">transitionFrom:</span><span class="n">SECrackRockState_Ready</span>         <span class="nl">to:</span><span class="n">SECrackRockState_Error</span><span class="p">];</span>
    <span class="p">[</span><span class="n">sm</span> <span class="nl">when:</span><span class="n">SECrackRockEvent_Error</span> <span class="nl">transitionFrom:</span><span class="n">SECrackRockState_Purchasing</span>    <span class="nl">to:</span><span class="n">SECrackRockState_Error</span><span class="p">];</span>
    <span class="p">[</span><span class="n">sm</span> <span class="nl">when:</span><span class="n">SECrackRockEvent_Error</span> <span class="nl">transitionFrom:</span><span class="n">SECrackRockState_Restoring</span>     <span class="nl">to:</span><span class="n">SECrackRockState_Error</span><span class="p">];</span>
    <span class="p">[</span><span class="n">sm</span> <span class="nl">when:</span><span class="n">SECrackRockEvent_Error</span> <span class="nl">transitionFrom:</span><span class="n">SECrackRockState_Requesting</span>    <span class="nl">to:</span><span class="n">SECrackRockState_Error</span><span class="p">];</span>
    <span class="p">[</span><span class="n">sm</span> <span class="nl">when:</span><span class="n">SECrackRockEvent_Error</span> <span class="nl">transitionFrom:</span><span class="n">SECrackRockState_Error</span>         <span class="nl">to:</span><span class="n">SECrackRockState_Error</span><span class="p">];</span>

    <span class="p">[</span><span class="n">sm</span> <span class="nl">before:</span><span class="n">SECrackRockState_Error</span> <span class="k">do</span><span class="o">:^</span><span class="p">(</span><span class="n">SECrackRock</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">[[</span><span class="n">SKPaymentQueue</span> <span class="n">defaultQueue</span><span class="p">]</span> <span class="nl">removeTransactionObserver:</span> <span class="p">(</span><span class="kt">id</span><span class="o">&lt;</span><span class="n">SKPaymentTransactionObserver</span><span class="o">&gt;</span><span class="p">)</span><span class="n">self</span><span class="p">];</span>
    <span class="p">}];</span></pre></div></td></tr><tr><td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11">&#182;</a>
</div>
<p>debug logging</p></td><td class="code highlight"><div class="highlight"><pre>    <span class="k">for</span> <span class="p">(</span><span class="kt">id</span> <span class="n">event</span> <span class="k">in</span> <span class="n">sm</span><span class="p">.</span><span class="n">events</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">[</span><span class="n">sm</span> <span class="nl">before:</span><span class="p">[</span><span class="n">event</span> <span class="n">name</span><span class="p">]</span> <span class="k">do</span><span class="o">:^</span><span class="p">(</span><span class="n">SECrackRock</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">lllog</span><span class="p">(</span><span class="n">Info</span><span class="p">,</span> <span class="s">@&quot;STATE TRANSITION: %@&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">event</span> <span class="n">name</span><span class="p">]);</span>
        <span class="p">}];</span>
    <span class="p">}</span>
<span class="p">});</span></pre></div></td></tr><tr><td class="docs"><div class="dox"><div class="summary">
<div class="pilwrap" id="instance-methods">
  <h2>
    <a href="#instance-methods" class="pilcrow">&#182;</a>
    Instance methods
  </h2>
</div>
</div><div class="body"></div></div></td><td class="code highlight"><div class="highlight"><pre><span class="cp">#pragma mark- Lifecycle</span>
<span class="cp">#pragma mark-</span></pre></div></td></tr><tr><td class="docs"><div class="dox"><div class="summary">
<div class="pilwrap" id="initwithfreeproducts-paidproductids-">
  <h4>
    <a href="#initwithfreeproducts-paidproductids-" class="pilcrow">&#182;</a>
    initWithFreeProducts:paidProductIDs:
  </h4>
</div>
</div><div class="body"></div><div class="details"><div class="dox_tag_title">Return</div><div class="dox_tag_detail"><span class="dox_type">id</span></div></div></div></td><td class="code highlight"><div class="highlight"><pre><span class="k">-</span> <span class="p">(</span><span class="n">instancetype</span><span class="p">)</span> <span class="nf">initWithFreeProducts:</span><span class="p">(</span><span class="n">NSSet</span> <span class="o">*</span><span class="p">)</span><span class="nv">freeProducts</span>
                         <span class="nf">paidProducts:</span><span class="p">(</span><span class="n">NSSet</span> <span class="o">*</span><span class="p">)</span><span class="nv">paidProducts</span>
<span class="p">{</span>

    <span class="n">self</span> <span class="o">=</span> <span class="p">[</span><span class="n">super</span> <span class="n">init</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="p">[</span><span class="n">self</span> <span class="n">initializeStateMachine</span><span class="p">];</span>

        <span class="n">_isCurrentlyRestoringMultiplePurchases</span> <span class="o">=</span> <span class="n">NO</span><span class="p">;</span>
        <span class="n">_restoreWasInitiatedByUser</span> <span class="o">=</span> <span class="n">NO</span><span class="p">;</span>
        <span class="n">_freeProducts</span> <span class="o">=</span> <span class="p">(</span><span class="n">freeProducts</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">)</span> <span class="o">?</span> <span class="p">[</span><span class="n">freeProducts</span> <span class="n">copy</span><span class="p">]</span> <span class="o">:</span> <span class="p">[</span><span class="n">NSSet</span> <span class="n">set</span><span class="p">];</span>
        <span class="n">_paidProducts</span> <span class="o">=</span> <span class="p">(</span><span class="n">paidProducts</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">)</span> <span class="o">?</span> <span class="p">[</span><span class="n">paidProducts</span> <span class="n">copy</span><span class="p">]</span> <span class="o">:</span> <span class="p">[</span><span class="n">NSSet</span> <span class="n">set</span><span class="p">];</span>

        <span class="n">yssert</span><span class="p">(</span><span class="n">_freeProducts</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">,</span> <span class="s">@&quot;_freeProducts is nil.&quot;</span><span class="p">);</span>
        <span class="n">yssert</span><span class="p">(</span><span class="n">_paidProducts</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">,</span> <span class="s">@&quot;_paidProducts is nil.&quot;</span><span class="p">);</span>

        <span class="n">RAC</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">products</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="n">RACSignal</span> <span class="nl">combineLatest:</span> <span class="err">@</span><span class="p">[</span> <span class="p">[[</span><span class="n">RACAbleWithStart</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">freeProducts</span><span class="p">)</span> <span class="n">distinctUntilChanged</span><span class="p">]</span> <span class="n">notNil</span><span class="p">],</span>
                                                          <span class="p">[[</span><span class="n">RACAbleWithStart</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">paidProducts</span><span class="p">)</span> <span class="n">distinctUntilChanged</span><span class="p">]</span> <span class="n">notNil</span><span class="p">],</span> <span class="p">]</span>
                                               <span class="nl">reduce:</span><span class="o">^</span><span class="n">NSSet</span> <span class="o">*</span><span class="p">(</span><span class="n">NSSet</span> <span class="o">*</span><span class="n">freeProducts</span><span class="p">,</span> <span class="n">NSSet</span> <span class="o">*</span><span class="n">paidProducts</span><span class="p">){</span>
                                                   <span class="k">return</span> <span class="p">[</span><span class="n">freeProducts</span> <span class="nl">setByAddingObjectsFromSet:</span><span class="n">paidProducts</span><span class="p">];</span>
                                               <span class="p">}];</span>
        <span class="n">yssert</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">products</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">,</span> <span class="s">@&quot;self.products is nil.&quot;</span><span class="p">);</span>

        <span class="n">RAC</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">productsByID</span><span class="p">)</span> <span class="o">=</span> <span class="p">[[</span><span class="n">RACAbleWithStart</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">products</span><span class="p">)</span> <span class="n">distinctUntilChanged</span><span class="p">]</span>
                                      <span class="nl">map:</span><span class="o">^</span><span class="kt">id</span><span class="p">(</span><span class="n">NSSet</span> <span class="o">*</span><span class="n">products</span><span class="p">)</span> <span class="p">{</span>

                                          <span class="n">NSMutableDictionary</span> <span class="o">*</span><span class="n">productsByID</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSMutableDictionary</span> <span class="nl">dictionaryWithCapacity:</span><span class="n">products</span><span class="p">.</span><span class="n">count</span><span class="p">];</span>
                                          <span class="k">for</span> <span class="p">(</span><span class="n">SECrackRockProduct</span> <span class="o">*</span><span class="n">product</span> <span class="k">in</span> <span class="n">products</span><span class="p">)</span> <span class="p">{</span>
                                              <span class="n">productsByID</span><span class="p">[</span> <span class="n">product</span><span class="p">.</span><span class="n">productID</span> <span class="p">]</span> <span class="o">=</span> <span class="n">product</span><span class="p">;</span>
                                          <span class="p">}</span>

                                          <span class="k">return</span> <span class="n">productsByID</span><span class="p">;</span>
                                      <span class="p">}];</span>
        <span class="n">yssert</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">productsByID</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">,</span> <span class="s">@&quot;self.productsByID is nil.&quot;</span><span class="p">);</span>


        <span class="n">RAC</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">purchasedProducts</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="n">RACSignal</span> <span class="nl">combineLatest:</span><span class="err">@</span><span class="p">[</span> <span class="p">[[[</span><span class="n">NSNotificationCenter</span> <span class="n">defaultCenter</span><span class="p">]</span> <span class="nl">rac_addObserverForName:</span><span class="n">SECrackRockNotification_CollectionWasUpdated</span> <span class="nl">object:</span><span class="n">self</span><span class="p">]</span> <span class="nl">startWith:</span><span class="n">RACDefaultUnit</span><span class="p">],</span>
                                                               <span class="p">[[</span><span class="n">RACAbleWithStart</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">productsByID</span><span class="p">)</span> <span class="n">distinctUntilChanged</span><span class="p">]</span> <span class="n">notNil</span><span class="p">],</span> <span class="p">]</span>
                                                     <span class="nl">reduce:</span><span class="o">^</span><span class="p">(</span><span class="kt">id</span> <span class="n">notification</span><span class="p">,</span> <span class="n">NSDictionary</span> <span class="o">*</span><span class="n">productsByID</span><span class="p">)</span> <span class="p">{</span>

                                                         <span class="n">lllog</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="s">@&quot;purchasedProducts did change (inner) = %@&quot;</span><span class="p">,</span> <span class="n">productsByID</span><span class="p">);</span>

                                                         <span class="n">NSMutableArray</span> <span class="o">*</span><span class="n">arr</span> <span class="o">=</span> <span class="err">@</span><span class="p">[].</span><span class="n">mutableCopy</span><span class="p">;</span>
                                                         <span class="k">for</span> <span class="p">(</span><span class="kt">id</span> <span class="n">key</span> <span class="k">in</span> <span class="n">productsByID</span><span class="p">)</span> <span class="p">{</span>
                                                             <span class="n">SECrackRockProduct</span> <span class="o">*</span><span class="n">product</span> <span class="o">=</span> <span class="n">productsByID</span><span class="p">[</span> <span class="n">key</span> <span class="p">];</span>
                                                             <span class="k">if</span> <span class="p">(</span><span class="n">product</span><span class="p">.</span><span class="n">hasBeenPurchased</span><span class="p">)</span> <span class="p">{</span>
                                                                 <span class="p">[</span><span class="n">arr</span> <span class="nl">addObject:</span><span class="n">product</span><span class="p">];</span>
                                                             <span class="p">}</span>
                                                         <span class="p">}</span>
                                                         <span class="k">return</span> <span class="p">[</span><span class="n">NSSet</span> <span class="nl">setWithArray:</span><span class="n">arr</span><span class="p">];</span>
                                                     <span class="p">}];</span>

        <span class="p">[</span><span class="n">RACAbleWithStart</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">purchasedProducts</span><span class="p">)</span> <span class="nl">subscribeNext:</span><span class="o">^</span><span class="p">(</span><span class="kt">id</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">lllog</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="s">@&quot;purchasedProducts did change (outer) = %@&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
        <span class="p">}];</span>

        <span class="n">yssert</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">purchasedProducts</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">,</span> <span class="s">@&quot;self.purchasedProducts is nil.&quot;</span><span class="p">);</span>

        <span class="n">RAC</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">freeAndPurchasedProducts</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="n">RACSignal</span> <span class="nl">combineLatest:</span> <span class="err">@</span><span class="p">[</span> <span class="p">[[</span><span class="n">RACAbleWithStart</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">purchasedProducts</span><span class="p">)</span> <span class="n">distinctUntilChanged</span><span class="p">]</span> <span class="n">notNil</span><span class="p">],</span>
                                                                       <span class="p">[[</span><span class="n">RACAbleWithStart</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">freeProducts</span><span class="p">)</span>   <span class="n">distinctUntilChanged</span><span class="p">]</span> <span class="n">notNil</span><span class="p">],</span> <span class="p">]</span>
                                                            <span class="nl">reduce:</span><span class="o">^</span><span class="kt">id</span> <span class="p">(</span><span class="n">NSSet</span> <span class="o">*</span><span class="n">purchasedItems</span><span class="p">,</span> <span class="n">NSSet</span> <span class="o">*</span><span class="n">freeProducts</span><span class="p">)</span> <span class="p">{</span>
                                                                <span class="n">yssert_notNilAndIsClass</span><span class="p">(</span><span class="n">purchasedItems</span><span class="p">,</span> <span class="n">NSSet</span><span class="p">);</span>
                                                                <span class="n">yssert_notNilAndIsClass</span><span class="p">(</span><span class="n">freeProducts</span><span class="p">,</span>   <span class="n">NSSet</span><span class="p">);</span>

                                                                <span class="k">return</span> <span class="p">[</span><span class="n">purchasedItems</span> <span class="nl">setByAddingObjectsFromSet:</span><span class="n">freeProducts</span><span class="p">];</span>
                                                            <span class="p">}];</span>
        <span class="n">yssert</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">freeAndPurchasedProducts</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">,</span> <span class="s">@&quot;self.freeAndPurchasedProducts is nil.&quot;</span><span class="p">);</span></pre></div></td></tr><tr><td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14">&#182;</a>
</div>
<p>add an observer to monitor the transaction status</p></td><td class="code highlight"><div class="highlight"><pre>        <span class="p">[[</span><span class="n">SKPaymentQueue</span> <span class="n">defaultQueue</span><span class="p">]</span> <span class="nl">addTransactionObserver:</span> <span class="p">(</span><span class="kt">id</span><span class="o">&lt;</span><span class="n">SKPaymentTransactionObserver</span><span class="o">&gt;</span><span class="p">)</span><span class="n">self</span><span class="p">];</span>

        <span class="p">[</span><span class="n">self</span> <span class="n">requestProducts</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">self</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr><tr><td class="docs"><div class="dox"><div class="summary">
<div class="pilwrap" id="dealloc">
  <h4>
    <a href="#dealloc" class="pilcrow">&#182;</a>
    dealloc
  </h4>
</div>
</div><div class="body"></div><div class="details"><div class="dox_tag_title">Return</div><div class="dox_tag_detail"><span class="dox_type">void</span></div></div></div></td><td class="code highlight"><div class="highlight"><pre><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">dealloc</span>
<span class="p">{</span>
    <span class="p">[[</span><span class="n">SKPaymentQueue</span> <span class="n">defaultQueue</span><span class="p">]</span> <span class="nl">removeTransactionObserver:</span> <span class="n">self</span><span class="p">];</span>
<span class="p">}</span>



<span class="cp">#pragma mark- Public interface</span>
<span class="cp">#pragma mark-</span>

<span class="cp">#pragma mark Purchase/restore</span></pre></div></td></tr><tr><td class="docs"><div class="dox"><div class="summary">
<div class="pilwrap" id="purchase-completion-">
  <h4>
    <a href="#purchase-completion-" class="pilcrow">&#182;</a>
    purchase:completion:
  </h4>
</div>
</div><div class="body"><p>Attempt to purchase this product.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span class="dox_type">NSString*</span><code class="name">productID</code></div><div class="dox_tag_title">Return</div><div class="dox_tag_detail"><span class="dox_type">void</span></div></div></div></td><td class="code highlight"><div class="highlight"><pre><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">purchase:</span> <span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">productID</span>
       <span class="nf">completion:</span> <span class="p">(</span><span class="n">SECrackRockTransactionResponseBlock</span><span class="p">)</span><span class="nv">blockCompletion</span>
<span class="p">{</span>
    <span class="n">yssert</span><span class="p">(</span><span class="n">productID</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">);</span>

    <span class="n">SECrackRockProduct</span> <span class="o">*</span><span class="n">product</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">productsByID</span><span class="p">[</span> <span class="n">productID</span> <span class="p">];</span>
    <span class="n">yssert</span><span class="p">(</span><span class="n">product</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">product</span><span class="p">.</span><span class="n">hasBeenPurchased</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">blockCompletion</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">blockCompletion</span><span class="p">(</span><span class="nb">nil</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr><tr><td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17">&#182;</a>
</div>
<p>IAP is not enabled, so bail</p></td><td class="code highlight"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">NO</span> <span class="o">==</span> <span class="p">[</span><span class="n">SKPaymentQueue</span> <span class="n">canMakePayments</span><span class="p">])</span>
    <span class="p">{</span>
        <span class="n">lllog</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="s">@&quot;IAP disabled&quot;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">blockCompletion</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">NSError</span> <span class="o">*</span><span class="n">error</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSError</span> <span class="nl">errorWithDomain:</span> <span class="s">@&quot;com.signalenvelope.SECrackRock.IAPDisabled&quot;</span> <span class="nl">code:</span><span class="mi">2</span>
                                             <span class="nl">userInfo:</span> <span class="err">@</span><span class="p">{</span> <span class="s">@&quot;description&quot;</span><span class="o">:</span> <span class="p">[</span><span class="n">NSString</span> <span class="nl">stringWithFormat:</span><span class="s">@&quot;In-app purchasing is disabled on this device.&quot;</span><span class="p">]</span> <span class="p">}];</span>
            <span class="n">blockCompletion</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">self</span><span class="p">.</span><span class="n">blockTransactionCompletion</span> <span class="o">=</span> <span class="n">blockCompletion</span><span class="p">;</span></pre></div></td></tr><tr><td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18">&#182;</a>
</div>
<p>create a payment request using the SKProduct we got back from our SKProductsRequest</p></td><td class="code highlight"><div class="highlight"><pre>    <span class="n">SKPayment</span> <span class="o">*</span><span class="n">paymentRequest</span> <span class="o">=</span> <span class="p">[</span><span class="n">SKPayment</span> <span class="nl">paymentWithProduct:</span> <span class="n">product</span><span class="p">.</span><span class="n">skProduct</span><span class="p">];</span></pre></div></td></tr><tr><td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19">&#182;</a>
</div>
<p>request a purchase of the product</p></td><td class="code highlight"><div class="highlight"><pre>    <span class="p">[</span><span class="n">SKPaymentQueue</span><span class="p">.</span><span class="n">defaultQueue</span> <span class="nl">addPayment:</span><span class="n">paymentRequest</span><span class="p">];</span>
<span class="p">}</span></pre></div></td></tr><tr><td class="docs"><div class="dox"><div class="summary">
<div class="pilwrap" id="restoreallpurchases-">
  <h4>
    <a href="#restoreallpurchases-" class="pilcrow">&#182;</a>
    restoreAllPurchases:
  </h4>
</div>
</div><div class="body"><p>Attempt to restore all purchases made with the current apple ID.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span class="dox_type">SECrackRockTransactionResponseBlock</span><code class="name">blockTransactionCompletion</code></div><div class="dox_tag_title">Return</div><div class="dox_tag_detail"><span class="dox_type">void</span></div></div></div></td><td class="code highlight"><div class="highlight"><pre><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">restoreAllPurchases:</span><span class="p">(</span><span class="n">SECrackRockTransactionResponseBlock</span><span class="p">)</span><span class="nv">blockTransactionCompletion</span>
<span class="p">{</span></pre></div></td></tr><tr><td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21">&#182;</a>
</div>
<p>IAP is disabled, so bail</p></td><td class="code highlight"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">NO</span> <span class="o">==</span> <span class="n">SKPaymentQueue</span><span class="p">.</span><span class="n">canMakePayments</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">blockTransactionCompletion</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">NSError</span> <span class="o">*</span><span class="n">error</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSError</span> <span class="nl">errorWithDomain:</span> <span class="s">@&quot;com.signalenvelope.SECrackRock.IAPDisabled&quot;</span> <span class="nl">code:</span><span class="mi">2</span>
                                             <span class="nl">userInfo:</span> <span class="err">@</span><span class="p">{</span> <span class="s">@&quot;description&quot;</span><span class="o">:</span> <span class="p">[</span><span class="n">NSString</span> <span class="nl">stringWithFormat:</span><span class="s">@&quot;In-app purchasing is disabled on this device.&quot;</span><span class="p">]</span> <span class="p">}];</span>

            <span class="n">blockTransactionCompletion</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">self</span><span class="p">.</span><span class="n">blockTransactionCompletion</span>            <span class="o">=</span> <span class="n">blockTransactionCompletion</span><span class="p">;</span>
    <span class="n">self</span><span class="p">.</span><span class="n">isCurrentlyRestoringMultiplePurchases</span> <span class="o">=</span> <span class="n">YES</span><span class="p">;</span>
    <span class="n">self</span><span class="p">.</span><span class="n">restoreWasInitiatedByUser</span>             <span class="o">=</span> <span class="n">YES</span><span class="p">;</span>

    <span class="p">[[</span><span class="n">SKPaymentQueue</span> <span class="n">defaultQueue</span><span class="p">]</span> <span class="n">restoreCompletedTransactions</span><span class="p">];</span>
<span class="p">}</span></pre></div></td></tr><tr><td class="docs">
<div class="pilwrap" id="pragma-mark-kvo">
  <h1>
    <a href="#pragma-mark-kvo" class="pilcrow">&#182;</a>
    pragma mark KVO
  </h1>
</div>


<p>/**
* keyPathsForValuesAffectingProducts
*/</p>

<ul>
<li>(NSSet *) keyPathsForValuesAffectingProducts
{
return [NSSet setWithArray: @[@"freeProducts", @"paidProducts"]];
}</li>
</ul>

<p>/**
* keyPathsForValuesAffectingProductsByID
*/</p>

<ul>
<li>(NSSet *) keyPathsForValuesAffectingProductsByID
{
return [NSSet setWithArray: @[@"products", @"freeProducts", @"paidProducts"]];
}</li>
</ul>

<p>/**
* keyPathsForValuesAffectingPurchasedItems
*/</p>

<ul>
<li>(NSSet *) keyPathsForValuesAffectingPurchasedItems
{
return [NSSet setWithArray: @[@"products", @"freeProducts", @"paidProducts"]];
}</li>
</ul></td><td class="code highlight"><div class="highlight"><pre></pre></div></td></tr><tr><td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23">&#182;</a>
</div>
<div class="dox"><div class="summary"><p>rac_products</p></div><div class="body"></div></div></td><td class="code highlight"><div class="highlight"><pre></pre></div></td></tr><tr><td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24">&#182;</a>
</div>
<ul>
<li>(RACSignal *) rac_products
{
return [RACSignal combineLatest: @[
        RACAbleWithStart(self.freeProducts),
        RACAbleWithStart(self.paidProducts),
    ] reduce:^NSSet *(NSSet *freeProducts, NSSet *paidProducts){
        return [freeProducts setByAddingObjectsFromSet:paidProducts];
    }];
}</li>
</ul></td><td class="code highlight"><div class="highlight"><pre><span class="cp">#pragma mark- Private interface</span>
<span class="cp">#pragma mark-</span>

<span class="cp">#pragma mark SECrackRockProductsRequest outcomes</span></pre></div></td></tr><tr><td class="docs"><div class="dox"><div class="summary">
<div class="pilwrap" id="requestedproductnotvalid-">
  <h4>
    <a href="#requestedproductnotvalid-" class="pilcrow">&#182;</a>
    requestedProductNotValid:
  </h4>
</div>
</div><div class="body"><p>The SECrackRockProductsRequest failed and the product is unavailable.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span class="dox_type">NSString*</span><code class="name">productID</code></div><div class="dox_tag_title">Return</div><div class="dox_tag_detail"><span class="dox_type">void</span></div></div></div></td><td class="code highlight"><div class="highlight"><pre><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">requestedProductNotValid:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">productID</span>
<span class="p">{</span>
    <span class="n">yssert</span><span class="p">(</span><span class="n">productID</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">,</span> <span class="s">@&quot;productID argument is nil.&quot;</span><span class="p">);</span>
    <span class="n">lllog</span><span class="p">(</span><span class="n">Warn</span><span class="p">,</span> <span class="s">@&quot;Product &#39;%@&#39; unavailable&quot;</span><span class="p">,</span> <span class="n">productID</span><span class="p">);</span>

    <span class="p">[</span><span class="n">self</span> <span class="nl">willChangeValueForKey:</span><span class="err">@</span><span class="n">keypath</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">paidProducts</span><span class="p">)];</span>

    <span class="n">SECrackRockProduct</span> <span class="o">*</span><span class="n">product</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">productsByID</span><span class="p">[</span> <span class="n">productID</span> <span class="p">];</span>
    <span class="n">yssert</span><span class="p">(</span><span class="n">product</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">,</span> <span class="s">@&quot;product is nil.&quot;</span><span class="p">);</span>

    <span class="n">product</span><span class="p">.</span><span class="n">isAvailableInStore</span> <span class="o">=</span> <span class="n">NO</span><span class="p">;</span>

    <span class="p">[</span><span class="n">self</span> <span class="nl">didChangeValueForKey:</span><span class="err">@</span><span class="n">keypath</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">paidProducts</span><span class="p">)];</span>
    <span class="p">[[</span><span class="n">NSNotificationCenter</span> <span class="n">defaultCenter</span><span class="p">]</span> <span class="nl">postNotificationName:</span><span class="n">SECrackRockNotification_CollectionWasUpdated</span> <span class="nl">object:</span><span class="n">self</span><span class="p">];</span>
<span class="p">}</span></pre></div></td></tr><tr><td class="docs"><div class="dox"><div class="summary">
<div class="pilwrap" id="requestedproductvalidated-">
  <h4>
    <a href="#requestedproductvalidated-" class="pilcrow">&#182;</a>
    requestedProductValidated:
  </h4>
</div>
</div><div class="body"><p>Request for product information to app store servers has returned. If the
product was found and is available for purchase, it's handed to this method.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span class="dox_type">SKProduct*</span><code class="name">skProduct</code></div><div class="dox_tag_title">Return</div><div class="dox_tag_detail"><span class="dox_type">void</span></div></div></div></td><td class="code highlight"><div class="highlight"><pre><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">requestedProductValidated:</span> <span class="p">(</span><span class="n">SKProduct</span> <span class="o">*</span><span class="p">)</span><span class="nv">skProduct</span>
<span class="p">{</span>
    <span class="n">yssert</span><span class="p">(</span><span class="n">skProduct</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">,</span> <span class="s">@&quot;skProduct argument is nil.&quot;</span><span class="p">);</span>
    <span class="n">lllog</span><span class="p">(</span><span class="n">Info</span><span class="p">,</span> <span class="s">@&quot;product validated: %@&quot;</span><span class="p">,</span> <span class="n">skProduct</span><span class="p">);</span>

    <span class="p">[</span><span class="n">self</span> <span class="nl">willChangeValueForKey:</span><span class="err">@</span><span class="n">keypath</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">paidProducts</span><span class="p">)];</span></pre></div></td></tr><tr><td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27">&#182;</a>
</div>
<p>localize the returned price string</p></td><td class="code highlight"><div class="highlight"><pre>    <span class="n">NSNumberFormatter</span> <span class="o">*</span><span class="n">formatter</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSNumberFormatter</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
    <span class="n">formatter</span><span class="p">.</span><span class="n">numberStyle</span>        <span class="o">=</span> <span class="n">NSNumberFormatterCurrencyStyle</span><span class="p">;</span>
    <span class="n">formatter</span><span class="p">.</span><span class="n">locale</span>             <span class="o">=</span> <span class="n">skProduct</span><span class="p">.</span><span class="n">priceLocale</span><span class="p">;</span>
    <span class="n">NSString</span> <span class="o">*</span><span class="n">localizedPrice</span>     <span class="o">=</span> <span class="p">[</span><span class="n">formatter</span> <span class="nl">stringFromNumber:</span><span class="n">skProduct</span><span class="p">.</span><span class="n">price</span><span class="p">];</span></pre></div></td></tr><tr><td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28">&#182;</a>
</div>
<p>find the product in our local product list and update it with whatever apple sent</p></td><td class="code highlight"><div class="highlight"><pre>    <span class="n">SECrackRockProduct</span> <span class="o">*</span><span class="n">productToUpdate</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">productsByID</span><span class="p">[</span> <span class="n">skProduct</span><span class="p">.</span><span class="n">productIdentifier</span> <span class="p">];</span>
    <span class="n">yssert</span><span class="p">(</span><span class="n">productToUpdate</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">,</span> <span class="s">@&quot;productToUpdate is nil.&quot;</span><span class="p">);</span>

    <span class="n">productToUpdate</span><span class="p">.</span><span class="n">productID</span>          <span class="o">=</span> <span class="n">skProduct</span><span class="p">.</span><span class="n">productIdentifier</span><span class="p">;</span>
    <span class="n">productToUpdate</span><span class="p">.</span><span class="n">readableName</span>       <span class="o">=</span> <span class="n">skProduct</span><span class="p">.</span><span class="n">localizedTitle</span><span class="p">;</span>
    <span class="n">productToUpdate</span><span class="p">.</span><span class="n">productDescription</span> <span class="o">=</span> <span class="n">skProduct</span><span class="p">.</span><span class="n">localizedDescription</span><span class="p">;</span>
    <span class="n">productToUpdate</span><span class="p">.</span><span class="n">price</span>              <span class="o">=</span> <span class="n">localizedPrice</span><span class="p">;</span>
    <span class="n">productToUpdate</span><span class="p">.</span><span class="n">skProduct</span>          <span class="o">=</span> <span class="n">skProduct</span><span class="p">;</span>
    <span class="n">productToUpdate</span><span class="p">.</span><span class="n">isAvailableInStore</span> <span class="o">=</span> <span class="n">YES</span><span class="p">;</span></pre></div></td></tr><tr><td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29">&#182;</a>
</div>
<p>productToUpdate.productStatus      = [self.purchasedProducts containsObject:productToUpdate.productID]
                                             ? SECrackRockProductStatusNonfreePurchased
                                             : SECrackRockProductStatusNonfreeUnpurchased;</p></td><td class="code highlight"><div class="highlight"><pre>    <span class="p">[</span><span class="n">self</span> <span class="nl">didChangeValueForKey:</span><span class="err">@</span><span class="n">keypath</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">paidProducts</span><span class="p">)];</span>
    <span class="p">[[</span><span class="n">NSNotificationCenter</span> <span class="n">defaultCenter</span><span class="p">]</span> <span class="nl">postNotificationName:</span><span class="n">SECrackRockNotification_CollectionWasUpdated</span> <span class="nl">object:</span><span class="n">self</span><span class="p">];</span>
<span class="p">}</span>









<span class="cp">#pragma mark Purchase/restore transaction outcomes</span></pre></div></td></tr><tr><td class="docs"><div class="dox"><div class="summary">
<div class="pilwrap" id="successfulpurchase-receipt-">
  <h4>
    <a href="#successfulpurchase-receipt-" class="pilcrow">&#182;</a>
    successfulPurchase:receipt:
  </h4>
</div>
</div><div class="body"><p>Purchase request was successful, so unlock the new content for your new
customer and notify them that the transaction was successful.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span class="dox_type">NSString*</span><code class="name">productID</code></div><div class="dox_tag_detail"><span class="dox_type">NSData*</span><code class="name">transactionReceipt</code></div><div class="dox_tag_title">Return</div><div class="dox_tag_detail"><span class="dox_type">void</span></div></div></div></td><td class="code highlight"><div class="highlight"><pre><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">successfulPurchase:</span> <span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">productID</span>
                    <span class="nf">receipt:</span> <span class="p">(</span><span class="n">NSData</span> <span class="o">*</span><span class="p">)</span><span class="nv">transactionReceipt</span>
<span class="p">{</span>
    <span class="n">yssert</span><span class="p">(</span><span class="n">productID</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">,</span> <span class="s">@&quot;productID argument is nil.&quot;</span><span class="p">);</span>
    <span class="n">yssert</span><span class="p">(</span><span class="n">transactionReceipt</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">,</span> <span class="s">@&quot;transactionReceipt argument is nil.&quot;</span><span class="p">);</span>

    <span class="n">lllog</span><span class="p">(</span><span class="n">Verbose</span><span class="p">,</span> <span class="s">@&quot;product ID: %@&quot;</span><span class="p">,</span> <span class="n">productID</span><span class="p">);</span></pre></div></td></tr><tr><td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31">&#182;</a>
</div>
<p>@weakify(self);
   [RACScheduler mainThreadScheduler] schedule:^{
       @strongify(self);</p></td><td class="code highlight"><div class="highlight"><pre>    <span class="p">[</span><span class="n">self</span> <span class="nl">willChangeValueForKey:</span><span class="err">@</span><span class="n">keypath</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">purchasedProducts</span><span class="p">)];</span>
    <span class="p">[</span><span class="n">self</span> <span class="nl">willChangeValueForKey:</span><span class="err">@</span><span class="n">keypath</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">productsByID</span><span class="p">)];</span></pre></div></td></tr><tr><td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32">&#182;</a>
</div>
<p>save a record that this has been purchased locally to the phone (ends up in NSUserDefaults)</p></td><td class="code highlight"><div class="highlight"><pre>    <span class="n">SECrackRockProduct</span> <span class="o">*</span><span class="n">product</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">productsByID</span><span class="p">[</span> <span class="n">productID</span> <span class="p">];</span>
    <span class="n">yssert</span><span class="p">(</span><span class="n">product</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">);</span>
    <span class="n">product</span><span class="p">.</span><span class="n">hasBeenPurchased</span> <span class="o">=</span> <span class="n">YES</span><span class="p">;</span>

    <span class="p">[</span><span class="n">self</span> <span class="nl">didChangeValueForKey:</span><span class="err">@</span><span class="n">keypath</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">productsByID</span><span class="p">)];</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">blockTransactionCompletion</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">self</span><span class="p">.</span><span class="n">blockTransactionCompletion</span><span class="p">(</span><span class="nb">nil</span><span class="p">);</span>
        <span class="n">self</span><span class="p">.</span><span class="n">blockTransactionCompletion</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="p">[</span><span class="n">self</span> <span class="n">transactionComplete</span><span class="p">];</span>
    <span class="p">[[</span><span class="n">NSNotificationCenter</span> <span class="n">defaultCenter</span><span class="p">]</span> <span class="nl">postNotificationName:</span><span class="n">SECrackRockNotification_CollectionWasUpdated</span> <span class="nl">object:</span><span class="n">self</span><span class="p">];</span>
<span class="p">}</span></pre></div></td></tr><tr><td class="docs"><div class="dox"><div class="summary">
<div class="pilwrap" id="cancelledpurchase-">
  <h4>
    <a href="#cancelledpurchase-" class="pilcrow">&#182;</a>
    cancelledPurchase:
  </h4>
</div>
</div><div class="body"><p>Purchase request was cancelled.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span class="dox_type">NSString*</span><code class="name">errorMessage</code></div><div class="dox_tag_title">Return</div><div class="dox_tag_detail"><span class="dox_type">void</span></div></div></div></td><td class="code highlight"><div class="highlight"><pre><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">cancelledPurchase:</span> <span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">errorMessage</span>
<span class="p">{</span>
    <span class="n">lllog</span><span class="p">(</span><span class="n">Warn</span><span class="p">,</span> <span class="s">@&quot;error message: %@&quot;</span><span class="p">,</span> <span class="n">errorMessage</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">blockTransactionCompletion</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NSError</span> <span class="o">*</span><span class="n">error</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSError</span> <span class="nl">errorWithDomain:</span> <span class="s">@&quot;com.signalenvelope.SECrackRock.CancelledTransaction&quot;</span> <span class="nl">code:</span><span class="mi">3</span>
                                         <span class="nl">userInfo:</span> <span class="err">@</span><span class="p">{</span> <span class="s">@&quot;message&quot;</span><span class="o">:</span> <span class="n">errorMessage</span> <span class="p">}];</span>

        <span class="n">self</span><span class="p">.</span><span class="n">blockTransactionCompletion</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
        <span class="n">self</span><span class="p">.</span><span class="n">blockTransactionCompletion</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="p">[</span><span class="n">self</span> <span class="n">transactionComplete</span><span class="p">];</span>
    <span class="p">[[</span><span class="n">NSNotificationCenter</span> <span class="n">defaultCenter</span><span class="p">]</span> <span class="nl">postNotificationName:</span><span class="n">SECrackRockNotification_CollectionWasUpdated</span> <span class="nl">object:</span><span class="n">self</span><span class="p">];</span>
<span class="p">}</span></pre></div></td></tr><tr><td class="docs"><div class="dox"><div class="summary">
<div class="pilwrap" id="failedpurchase-message-">
  <h4>
    <a href="#failedpurchase-message-" class="pilcrow">&#182;</a>
    failedPurchase:message:
  </h4>
</div>
</div><div class="body"><p>Purchase request failed.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span class="dox_type">NSInteger</span><code class="name">errorCode</code></div><div class="dox_tag_detail"><span class="dox_type">NSString*</span><code class="name">errorMessage</code></div><div class="dox_tag_title">Return</div><div class="dox_tag_detail"><span class="dox_type">void</span></div></div></div></td><td class="code highlight"><div class="highlight"><pre><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">failedPurchase:</span> <span class="p">(</span><span class="n">NSInteger</span><span class="p">)</span><span class="nv">errorCode</span>
                <span class="nf">message:</span> <span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">errorMessage</span> <span class="p">{</span>

    <span class="n">lllog</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="s">@&quot;error message: %@&quot;</span><span class="p">,</span> <span class="n">errorMessage</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">blockTransactionCompletion</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NSError</span> <span class="o">*</span><span class="n">error</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSError</span> <span class="nl">errorWithDomain:</span> <span class="s">@&quot;com.signalenvelope.SECrackRock.CancelledTransaction&quot;</span> <span class="nl">code:</span><span class="mi">3</span>
                                         <span class="nl">userInfo:</span> <span class="err">@</span><span class="p">{</span> <span class="s">@&quot;message&quot;</span><span class="o">:</span> <span class="n">errorMessage</span> <span class="p">}];</span>

        <span class="n">self</span><span class="p">.</span><span class="n">blockTransactionCompletion</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
        <span class="n">self</span><span class="p">.</span><span class="n">blockTransactionCompletion</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="p">[</span><span class="n">self</span> <span class="n">transactionComplete</span><span class="p">];</span>
    <span class="p">[[</span><span class="n">NSNotificationCenter</span> <span class="n">defaultCenter</span><span class="p">]</span> <span class="nl">postNotificationName:</span><span class="n">SECrackRockNotification_CollectionWasUpdated</span> <span class="nl">object:</span><span class="n">self</span><span class="p">];</span>
<span class="p">}</span></pre></div></td></tr><tr><td class="docs"><div class="dox"><div class="summary">
<div class="pilwrap" id="successfulrestore-receipt-">
  <h4>
    <a href="#successfulrestore-receipt-" class="pilcrow">&#182;</a>
    successfulRestore:receipt:
  </h4>
</div>
</div><div class="body"><p>Restore request was successful, so unlock the purchased content for your
customer and notify them.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span class="dox_type">NSString*</span><code class="name">productID</code></div><div class="dox_tag_detail"><span class="dox_type">NSData*</span><code class="name">transactionReceipt</code></div><div class="dox_tag_title">Return</div><div class="dox_tag_detail"><span class="dox_type">void</span></div></div></div></td><td class="code highlight"><div class="highlight"><pre><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">successfulRestore:</span> <span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">productID</span>
                   <span class="nf">receipt:</span> <span class="p">(</span><span class="n">NSData</span> <span class="o">*</span><span class="p">)</span><span class="nv">transactionReceipt</span> <span class="p">{</span>

    <span class="n">yssert</span><span class="p">(</span><span class="n">productID</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">,</span> <span class="s">@&quot;productID argument is nil.&quot;</span><span class="p">);</span>
    <span class="n">yssert</span><span class="p">(</span><span class="n">transactionReceipt</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">,</span> <span class="s">@&quot;transactionReceipt argument is nil.&quot;</span><span class="p">);</span>
    <span class="n">lllog</span><span class="p">(</span><span class="n">Verbose</span><span class="p">,</span> <span class="s">@&quot;product ID: %@&quot;</span><span class="p">,</span> <span class="n">productID</span><span class="p">);</span>

    <span class="p">[</span><span class="n">self</span> <span class="nl">willChangeValueForKey:</span><span class="err">@</span><span class="n">keypath</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">paidProducts</span><span class="p">)];</span>

    <span class="n">SECrackRockProduct</span> <span class="o">*</span><span class="n">product</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">productsByID</span><span class="p">[</span> <span class="n">productID</span> <span class="p">];</span>
    <span class="n">yssert</span><span class="p">(</span><span class="n">product</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">);</span>
    <span class="n">product</span><span class="p">.</span><span class="n">hasBeenPurchased</span> <span class="o">=</span> <span class="n">YES</span><span class="p">;</span>

    <span class="p">[</span><span class="n">self</span> <span class="nl">didChangeValueForKey:</span><span class="err">@</span><span class="n">keypath</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">paidProducts</span><span class="p">)];</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">isCurrentlyRestoringMultiplePurchases</span> <span class="o">==</span> <span class="n">NO</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">blockTransactionCompletion</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">self</span><span class="p">.</span><span class="n">blockTransactionCompletion</span><span class="p">(</span><span class="nb">nil</span><span class="p">);</span>
            <span class="n">self</span><span class="p">.</span><span class="n">blockTransactionCompletion</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
            <span class="p">[[</span><span class="n">NSNotificationCenter</span> <span class="n">defaultCenter</span><span class="p">]</span> <span class="nl">postNotificationName:</span><span class="n">SECrackRockNotification_CollectionWasUpdated</span> <span class="nl">object:</span><span class="n">self</span><span class="p">];</span>
        <span class="p">}</span>

        <span class="p">[</span><span class="n">self</span> <span class="n">transactionComplete</span><span class="p">];</span>
    <span class="p">}</span></pre></div></td></tr><tr><td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-36" id="section-36">&#182;</a>
</div>
<p>// save a record that this has been purchased locally to the phone (ends up in NSUserDefaults)
   [self setProductHasBeenPurchased: productID];
   [NSNotificationCenter.defaultCenter postNotificationName: SECrackRockNotification_SuccessfulRestore
                                                     object: self
                                                   userInfo: @{ SECrackRockUserInfoKey_CrackRock: self,
                                                                SECrackRockUserInfoKey_ProductID: productID,
                                                                SECrackRockUserInfoKey_Receipt:   transactionReceipt }];</p></td><td class="code highlight"><div class="highlight"><pre></pre></div></td></tr><tr><td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-37" id="section-37">&#182;</a>
</div>
<p>// if it's a single item restore initiated by the user, end the transaction state
   if (self.restoreWasInitiatedByUser == YES &amp;&amp; self.isCurrentlyRestoringMultiplePurchases == NO) {</p>


<div class="highlight"><pre><code>   <span class="n">BrynFnLog</span><span class="p">(</span><span class="s">@&quot;self.restoreWasInitiatedByUser == YES  and  isCurrentlyRestoringMultiplePurchases == NO&quot;</span><span class="p">);</span>

   <span class="n">self</span><span class="p">.</span><span class="n">restoreWasInitiatedByUser</span> <span class="o">=</span> <span class="n">NO</span><span class="p">;</span>
</code></pre></div>



<p>}</p></td><td class="code highlight"><div class="highlight"><pre><span class="p">}</span></pre></div></td></tr><tr><td class="docs"><div class="dox"><div class="summary">
<div class="pilwrap" id="successfulmultiplerestorecomplete">
  <h4>
    <a href="#successfulmultiplerestorecomplete" class="pilcrow">&#182;</a>
    successfulMultipleRestoreComplete
  </h4>
</div>
</div><div class="body"><p>All restore requests in the transaction queue have succeeded.</p></div><div class="details"><div class="dox_tag_title">Return</div><div class="dox_tag_detail"><span class="dox_type">void</span></div></div></div></td><td class="code highlight"><div class="highlight"><pre><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">successfulMultipleRestoreComplete</span> <span class="p">{</span>
    <span class="n">lllog</span><span class="p">(</span><span class="n">Verbose</span><span class="p">,</span> <span class="s">@&quot;entering method&quot;</span><span class="p">);</span></pre></div></td></tr><tr><td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-39" id="section-39">&#182;</a>
</div>
<p>// unset flags describing the user-initiated multiple restore state
   if (self.restoreWasInitiatedByUser) {
       [self storeTransactionDidEnd:SECrackRockStoreTransactionTypeRestore];
   }</p></td><td class="code highlight"><div class="highlight"><pre>    <span class="n">self</span><span class="p">.</span><span class="n">isCurrentlyRestoringMultiplePurchases</span> <span class="o">=</span> <span class="n">NO</span><span class="p">;</span>
    <span class="n">self</span><span class="p">.</span><span class="n">restoreWasInitiatedByUser</span> <span class="o">=</span> <span class="n">NO</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">blockTransactionCompletion</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">self</span><span class="p">.</span><span class="n">blockTransactionCompletion</span><span class="p">(</span><span class="nb">nil</span><span class="p">);</span>
        <span class="n">self</span><span class="p">.</span><span class="n">blockTransactionCompletion</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="p">[</span><span class="n">self</span> <span class="n">transactionComplete</span><span class="p">];</span>
    <span class="p">[[</span><span class="n">NSNotificationCenter</span> <span class="n">defaultCenter</span><span class="p">]</span> <span class="nl">postNotificationName:</span><span class="n">SECrackRockNotification_CollectionWasUpdated</span> <span class="nl">object:</span><span class="n">self</span><span class="p">];</span>
<span class="p">}</span></pre></div></td></tr><tr><td class="docs"><div class="dox"><div class="summary">
<div class="pilwrap" id="incompleterestore">
  <h4>
    <a href="#incompleterestore" class="pilcrow">&#182;</a>
    incompleteRestore
  </h4>
</div>
</div><div class="body"><p>Restore queue did not include any transactions, so either the user has not yet made a purchase
or the user's prior purchase is unavailable, so notify user to make a purchase within the app.
If the user previously purchased the item, they will NOT be re-charged again, but it should
restore their purchase.</p></div><div class="details"><div class="dox_tag_title">Return</div><div class="dox_tag_detail"><span class="dox_type">void</span></div></div></div></td><td class="code highlight"><div class="highlight"><pre><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">incompleteRestore</span> <span class="p">{</span>
    <span class="n">lllog</span><span class="p">(</span><span class="n">Info</span><span class="p">,</span> <span class="s">@&quot;incomplete restore&quot;</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">blockTransactionCompletion</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NSError</span> <span class="o">*</span><span class="n">error</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSError</span> <span class="nl">errorWithDomain:</span> <span class="s">@&quot;com.signalenvelope.SECrackRock.IncompleteRestore&quot;</span> <span class="nl">code:</span><span class="mi">3</span>
                                         <span class="nl">userInfo:</span> <span class="err">@</span><span class="p">{</span> <span class="s">@&quot;message&quot;</span><span class="o">:</span> <span class="s">@&quot;Restore queue was empty.  Try purchasing again.&quot;</span> <span class="p">}];</span>

        <span class="n">self</span><span class="p">.</span><span class="n">blockTransactionCompletion</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
        <span class="n">self</span><span class="p">.</span><span class="n">blockTransactionCompletion</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="p">[</span><span class="n">self</span> <span class="n">transactionComplete</span><span class="p">];</span>
    <span class="p">[[</span><span class="n">NSNotificationCenter</span> <span class="n">defaultCenter</span><span class="p">]</span> <span class="nl">postNotificationName:</span><span class="n">SECrackRockNotification_CollectionWasUpdated</span> <span class="nl">object:</span><span class="n">self</span><span class="p">];</span>
<span class="p">}</span></pre></div></td></tr><tr><td class="docs"><div class="dox"><div class="summary">
<div class="pilwrap" id="failedrestore-message-">
  <h4>
    <a href="#failedrestore-message-" class="pilcrow">&#182;</a>
    failedRestore:message:
  </h4>
</div>
</div><div class="body"><p>Restore request failed or was cancelled, so notify the user.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span class="dox_type">NSInteger</span><code class="name">errorCode</code></div><div class="dox_tag_detail"><span class="dox_type">NSString*</span><code class="name">errorMessage</code></div><div class="dox_tag_title">Return</div><div class="dox_tag_detail"><span class="dox_type">void</span></div></div></div></td><td class="code highlight"><div class="highlight"><pre><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">failedRestore:</span> <span class="p">(</span><span class="n">NSInteger</span><span class="p">)</span> <span class="n">errorCode</span>
               <span class="nl">message:</span> <span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span> <span class="n">errorMessage</span> <span class="p">{</span>

    <span class="n">lllog</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="s">@&quot;error message: %@&quot;</span><span class="p">,</span> <span class="n">errorMessage</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">blockTransactionCompletion</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NSError</span> <span class="o">*</span><span class="n">error</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSError</span> <span class="nl">errorWithDomain:</span> <span class="s">@&quot;com.signalenvelope.SECrackRock.FailedRestore&quot;</span> <span class="nl">code:</span><span class="mi">3</span>
                                         <span class="nl">userInfo:</span> <span class="err">@</span><span class="p">{</span> <span class="s">@&quot;message&quot;</span><span class="o">:</span> <span class="n">errorMessage</span> <span class="p">}];</span>

        <span class="n">self</span><span class="p">.</span><span class="n">blockTransactionCompletion</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
        <span class="n">self</span><span class="p">.</span><span class="n">blockTransactionCompletion</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="p">[</span><span class="n">self</span> <span class="n">transactionComplete</span><span class="p">];</span>
    <span class="p">[[</span><span class="n">NSNotificationCenter</span> <span class="n">defaultCenter</span><span class="p">]</span> <span class="nl">postNotificationName:</span><span class="n">SECrackRockNotification_CollectionWasUpdated</span> <span class="nl">object:</span><span class="n">self</span><span class="p">];</span>
<span class="p">}</span>


<span class="k">@end</span>



<span class="cp">#pragma mark- SKPaymentTransactionObserver methods</span>
<span class="cp">#pragma mark-</span>

<span class="k">@implementation</span> <span class="nc">SECrackRock</span> <span class="nl">(SKPaymentTransactionObserver)</span></pre></div></td></tr><tr><td class="docs"><div class="dox"><div class="summary">
<div class="pilwrap" id="paymentqueue-updatedtransactions-">
  <h4>
    <a href="#paymentqueue-updatedtransactions-" class="pilcrow">&#182;</a>
    paymentQueue:updatedTransactions:
  </h4>
</div>
</div><div class="body"><p>The transaction status of the SKPaymentQueue is sent here.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span class="dox_type">SKPaymentQueue*</span><code class="name">queue</code></div><div class="dox_tag_detail"><span class="dox_type">NSArray*</span><code class="name">transactions</code></div><div class="dox_tag_title"></div><div class="dox_tag_detail"></div><div class="dox_tag_title">Return</div><div class="dox_tag_detail"><span class="dox_type">void</span></div></div></div></td><td class="code highlight"><div class="highlight"><pre><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>    <span class="nf">paymentQueue:</span> <span class="p">(</span><span class="n">SKPaymentQueue</span> <span class="o">*</span><span class="p">)</span><span class="nv">queue</span>
     <span class="nf">updatedTransactions:</span> <span class="p">(</span><span class="n">NSArray</span> <span class="o">*</span><span class="p">)</span><span class="nv">transactions</span>
<span class="p">{</span>
    <span class="n">lllog</span><span class="p">(</span><span class="n">Verbose</span><span class="p">,</span> <span class="s">@&quot;%@&quot;</span><span class="p">,</span> <span class="n">transactions</span><span class="p">);</span>

    <span class="n">yssert</span><span class="p">(</span><span class="n">queue</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">,</span> <span class="s">@&quot;queue argument is nil.&quot;</span><span class="p">);</span>
    <span class="n">yssert</span><span class="p">(</span><span class="n">transactions</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">,</span> <span class="s">@&quot;transactions argument is nil.&quot;</span><span class="p">);</span>

    <span class="n">NSMutableArray</span> <span class="o">*</span><span class="n">restores</span> <span class="o">=</span> <span class="n">NSMutableArray</span><span class="p">.</span><span class="n">array</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">SKPaymentTransaction</span> <span class="o">*</span><span class="n">transaction</span> <span class="k">in</span> <span class="n">transactions</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">switch</span> <span class="p">(</span><span class="n">transaction</span><span class="p">.</span><span class="n">transactionState</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="nl">SKPaymentTransactionStatePurchasing:</span> <span class="p">{</span>
                <span class="n">lllog</span><span class="p">(</span><span class="n">Info</span><span class="p">,</span> <span class="s">@&quot;transaction state = Purchasing&quot;</span><span class="p">);</span></pre></div></td></tr><tr><td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-43" id="section-43">&#182;</a>
</div>
<p>Item is still in the process of being purchased</p></td><td class="code highlight"><div class="highlight"><pre>            <span class="p">}</span> <span class="k">break</span><span class="p">;</span>

            <span class="k">case</span> <span class="nl">SKPaymentTransactionStatePurchased:</span> <span class="p">{</span>
                <span class="n">lllog</span><span class="p">(</span><span class="n">Info</span><span class="p">,</span> <span class="s">@&quot;transaction state = Purchased&quot;</span><span class="p">);</span></pre></div></td></tr><tr><td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-44" id="section-44">&#182;</a>
</div>
<p>Item was successfully purchased!</p></td><td class="code highlight"><div class="highlight"><pre></pre></div></td></tr><tr><td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-45" id="section-45">&#182;</a>
</div>
<p>Return transaction data. App should provide user with purchased product.</p></td><td class="code highlight"><div class="highlight"><pre>                <span class="p">[</span><span class="n">self</span> <span class="nl">successfulPurchase:</span> <span class="n">transaction</span><span class="p">.</span><span class="n">payment</span><span class="p">.</span><span class="n">productIdentifier</span>
                                 <span class="nl">receipt:</span> <span class="n">transaction</span><span class="p">.</span><span class="n">transactionReceipt</span><span class="p">];</span></pre></div></td></tr><tr><td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-46" id="section-46">&#182;</a>
</div>
<p>After customer has successfully received purchased content,
remove the finished transaction from the payment queue.</p></td><td class="code highlight"><div class="highlight"><pre>                <span class="p">[[</span><span class="n">SKPaymentQueue</span> <span class="n">defaultQueue</span><span class="p">]</span> <span class="nl">finishTransaction:</span> <span class="n">transaction</span><span class="p">];</span>
            <span class="p">}</span> <span class="k">break</span><span class="p">;</span>

            <span class="k">case</span> <span class="nl">SKPaymentTransactionStateRestored:</span> <span class="p">{</span>
                <span class="n">lllog</span><span class="p">(</span><span class="n">Info</span><span class="p">,</span> <span class="s">@&quot;transaction state = Restored&quot;</span><span class="p">);</span></pre></div></td></tr><tr><td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-47" id="section-47">&#182;</a>
</div>
<p>Verified that user has already paid for this item.</p></td><td class="code highlight"><div class="highlight"><pre>                <span class="p">[</span><span class="n">restores</span> <span class="nl">addObject:</span><span class="n">transaction</span><span class="p">];</span>
            <span class="p">}</span> <span class="k">break</span><span class="p">;</span>

            <span class="k">case</span> <span class="nl">SKPaymentTransactionStateFailed:</span> <span class="p">{</span></pre></div></td></tr><tr><td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-48" id="section-48">&#182;</a>
</div>
<p>Purchase was either cancelled by user or an error occurred.</p></td><td class="code highlight"><div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="n">transaction</span><span class="p">.</span><span class="n">error</span><span class="p">.</span><span class="n">code</span> <span class="o">==</span> <span class="n">SKErrorPaymentCancelled</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">lllog</span><span class="p">(</span><span class="n">Info</span><span class="p">,</span> <span class="s">@&quot;transaction state = Cancelled&quot;</span><span class="p">);</span>

                    <span class="p">[</span><span class="n">self</span> <span class="nl">cancelledPurchase:</span> <span class="n">transaction</span><span class="p">.</span><span class="n">error</span><span class="p">.</span><span class="n">localizedDescription</span><span class="p">];</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>
                    <span class="n">lllog</span><span class="p">(</span><span class="n">Info</span><span class="p">,</span> <span class="s">@&quot;transaction state = Failed&quot;</span><span class="p">);</span>

                    <span class="p">[</span><span class="n">self</span> <span class="nl">failedPurchase:</span> <span class="n">transaction</span><span class="p">.</span><span class="n">error</span><span class="p">.</span><span class="n">code</span>
                                 <span class="nl">message:</span> <span class="n">transaction</span><span class="p">.</span><span class="n">error</span><span class="p">.</span><span class="n">localizedDescription</span><span class="p">];</span>
                <span class="p">}</span></pre></div></td></tr><tr><td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-49" id="section-49">&#182;</a>
</div>
<p>Finished transactions should be removed from the payment queue.</p></td><td class="code highlight"><div class="highlight"><pre>                <span class="p">[[</span><span class="n">SKPaymentQueue</span> <span class="n">defaultQueue</span><span class="p">]</span> <span class="nl">finishTransaction:</span> <span class="n">transaction</span><span class="p">];</span>
            <span class="p">}</span> <span class="k">break</span><span class="p">;</span>


            <span class="k">default</span><span class="o">:</span> <span class="p">{</span></pre></div></td></tr><tr><td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-50" id="section-50">&#182;</a>
</div>
<p>automatically throw an assertion failure exception if the transactionState is not a defined value</p></td><td class="code highlight"><div class="highlight"><pre>                <span class="n">yssert</span><span class="p">(</span><span class="n">NO</span><span class="p">,</span> <span class="s">@&quot;transactionState is an unknown value.&quot;</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span></pre></div></td></tr><tr><td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-51" id="section-51">&#182;</a>
</div>
<p>process restores separately so that we can accurately set the "restoring
multiple purchases" flag if necessary</p></td><td class="code highlight"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">restores</span><span class="p">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">isCurrentlyRestoringMultiplePurchases</span> <span class="o">=</span> <span class="n">YES</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">SKPaymentTransaction</span> <span class="o">*</span><span class="n">transaction</span> <span class="k">in</span> <span class="n">restores</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr><td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-52" id="section-52">&#182;</a>
</div>
<p>Return transaction data. App should provide user with purchased product.</p></td><td class="code highlight"><div class="highlight"><pre>        <span class="p">[</span><span class="n">self</span> <span class="nl">successfulRestore:</span> <span class="n">transaction</span><span class="p">.</span><span class="n">payment</span><span class="p">.</span><span class="n">productIdentifier</span>
                        <span class="nl">receipt:</span> <span class="n">transaction</span><span class="p">.</span><span class="n">transactionReceipt</span><span class="p">];</span></pre></div></td></tr><tr><td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-53" id="section-53">&#182;</a>
</div>
<p>After customer has restored purchased content on this device,
remove the finished transaction from the payment queue.</p></td><td class="code highlight"><div class="highlight"><pre>        <span class="p">[[</span><span class="n">SKPaymentQueue</span> <span class="n">defaultQueue</span><span class="p">]</span> <span class="nl">finishTransaction:</span> <span class="n">transaction</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="n">self</span><span class="p">.</span><span class="n">isCurrentlyRestoringMultiplePurchases</span> <span class="o">=</span> <span class="n">NO</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr><tr><td class="docs"><div class="dox"><div class="summary">
<div class="pilwrap" id="paymentqueue-removedtransactions-">
  <h4>
    <a href="#paymentqueue-removedtransactions-" class="pilcrow">&#182;</a>
    paymentQueue:removedTransactions:
  </h4>
</div>
</div><div class="body"><p>Called when one or more transactions have been removed from the queue.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span class="dox_type">SKPaymentQueue*</span><code class="name">queue</code></div><div class="dox_tag_detail"><span class="dox_type">NSArray*</span><code class="name">transactions</code></div><div class="dox_tag_title">Return</div><div class="dox_tag_detail"><span class="dox_type">void</span></div></div></div></td><td class="code highlight"><div class="highlight"><pre><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>   <span class="nf">paymentQueue:</span> <span class="p">(</span><span class="n">SKPaymentQueue</span> <span class="o">*</span><span class="p">)</span><span class="nv">queue</span>
    <span class="nf">removedTransactions:</span> <span class="p">(</span><span class="n">NSArray</span> <span class="o">*</span><span class="p">)</span><span class="nv">transactions</span>
<span class="p">{</span>
    <span class="n">lllog</span><span class="p">(</span><span class="n">Verbose</span><span class="p">,</span> <span class="s">@&quot;transactions: %@&quot;</span><span class="p">,</span> <span class="n">transactions</span><span class="p">);</span>

    <span class="n">yssert</span><span class="p">(</span><span class="n">queue</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">,</span> <span class="s">@&quot;queue argument is nil.&quot;</span><span class="p">);</span>
    <span class="n">yssert</span><span class="p">(</span><span class="n">transactions</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">,</span> <span class="s">@&quot;transactions argument is nil.&quot;</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr><tr><td class="docs"><div class="dox"><div class="summary">
<div class="pilwrap" id="paymentqueuerestorecompletedtransactionsfinished-">
  <h4>
    <a href="#paymentqueuerestorecompletedtransactionsfinished-" class="pilcrow">&#182;</a>
    paymentQueueRestoreCompletedTransactionsFinished:
  </h4>
</div>
</div><div class="body"><p>Called when SKPaymentQueue has finished sending restored transactions.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span class="dox_type">SKPaymentQueue*</span><code class="name">queue</code></div><div class="dox_tag_title">Return</div><div class="dox_tag_detail"><span class="dox_type">void</span></div></div></div></td><td class="code highlight"><div class="highlight"><pre><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">paymentQueueRestoreCompletedTransactionsFinished:</span><span class="p">(</span><span class="n">SKPaymentQueue</span> <span class="o">*</span><span class="p">)</span><span class="nv">queue</span> <span class="p">{</span>
    <span class="n">yssert</span><span class="p">(</span><span class="n">queue</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">,</span> <span class="s">@&quot;queue argument is nil.&quot;</span><span class="p">);</span>

    <span class="n">lllog</span><span class="p">(</span><span class="n">Verbose</span><span class="p">,</span> <span class="s">@&quot;queue: %@&quot;</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">queue</span><span class="p">.</span><span class="n">transactions</span><span class="p">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">lllog</span><span class="p">(</span><span class="n">Warn</span><span class="p">,</span> <span class="s">@&quot;restore queue.transactions count == 0&quot;</span><span class="p">);</span></pre></div></td></tr><tr><td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-56" id="section-56">&#182;</a>
</div>
<p>Queue does not include any transactions, so either user has not yet made a purchase
or the user's prior purchase is unavailable, so notify app (and user) accordingly.</p></td><td class="code highlight"><div class="highlight"><pre>        <span class="p">[</span><span class="n">self</span> <span class="n">incompleteRestore</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span></pre></div></td></tr><tr><td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-57" id="section-57">&#182;</a>
</div>
<p>Queue does contain one or more transactions, so return transaction data.
App should provide user with purchased product.</p></td><td class="code highlight"><div class="highlight"><pre>        <span class="n">lllog</span><span class="p">(</span><span class="n">Verbose</span><span class="p">,</span> <span class="s">@&quot;restore queue.transactions available&quot;</span><span class="p">);</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">SKPaymentTransaction</span> <span class="o">*</span><span class="n">transaction</span> <span class="k">in</span> <span class="n">queue</span><span class="p">.</span><span class="n">transactions</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">lllog</span><span class="p">(</span><span class="n">Verbose</span><span class="p">,</span> <span class="s">@&quot;restore queue.transactions - transaction data found&quot;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">lllog</span><span class="p">(</span><span class="n">Info</span><span class="p">,</span> <span class="s">@&quot;multiple restore was successful&quot;</span><span class="p">);</span>
        <span class="p">[</span><span class="n">self</span> <span class="n">successfulMultipleRestoreComplete</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span></pre></div></td></tr><tr><td class="docs"><div class="dox"><div class="summary">
<div class="pilwrap" id="paymentqueue-restorecompletedtransactionsfailedwitherror-">
  <h4>
    <a href="#paymentqueue-restorecompletedtransactionsfailedwitherror-" class="pilcrow">&#182;</a>
    paymentQueue:restoreCompletedTransactionsFailedWithError:
  </h4>
</div>
</div><div class="body"><p>Called if an error occurred while restoring transactions.</p></div><div class="details"><div class="dox_tag_title">Params</div><div class="dox_tag_detail"><span class="dox_type">SKPaymentQueue*</span><code class="name">queue</code></div><div class="dox_tag_detail"><span class="dox_type">NSError*</span><code class="name">error</code></div><div class="dox_tag_title"></div><div class="dox_tag_detail"></div><div class="dox_tag_title">Return</div><div class="dox_tag_detail"><span class="dox_type">void</span></div></div></div></td><td class="code highlight"><div class="highlight"><pre><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>               <span class="nf">paymentQueue:</span> <span class="p">(</span><span class="n">SKPaymentQueue</span> <span class="o">*</span><span class="p">)</span><span class="nv">queue</span>
    <span class="nf">restoreCompletedTransactionsFailedWithError:</span> <span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="p">)</span><span class="nv">error</span>
<span class="p">{</span>
    <span class="n">lllog</span><span class="p">(</span><span class="n">Error</span><span class="p">,</span> <span class="s">@&quot;error: %@&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>

    <span class="n">yssert</span><span class="p">(</span><span class="n">queue</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">,</span> <span class="s">@&quot;queue argument is nil.&quot;</span><span class="p">);</span>
    <span class="n">yssert</span><span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">,</span> <span class="s">@&quot;error argument is nil.&quot;</span><span class="p">);</span></pre></div></td></tr><tr><td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-59" id="section-59">&#182;</a>
</div>
<p>Restore was cancelled or an error occurred, so notify user.</p></td><td class="code highlight"><div class="highlight"><pre>    <span class="p">[</span><span class="n">self</span> <span class="nl">failedRestore:</span> <span class="n">error</span><span class="p">.</span><span class="n">code</span>
                <span class="nl">message:</span> <span class="n">error</span><span class="p">.</span><span class="n">localizedDescription</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">@end</span>
</pre></div></td></tr></tbody></table></div></body></html>